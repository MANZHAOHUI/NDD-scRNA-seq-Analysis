#!/usr/bin/env Rscript
# Step 10: Vulnerability Analysis with AUCell

source("scripts/config.R")

suppressPackageStartupMessages({
  library(Seurat)
  library(AUCell)
  library(GSEABase)
  library(ggplot2)
})

# AUCell vulnerability scoring
identify_vulnerable_cells <- function(seurat_obj, gwas_genes, deg_genes, output_dir) {
  message("Running AUCell vulnerability analysis...")
  
  # Build risk gene set
  risk_genes <- intersect(gwas_genes, deg_genes)
  
  message("  GWAS genes: ", length(gwas_genes))
  message("  DEG genes: ", length(deg_genes))
  message("  Risk genes (intersection): ", length(risk_genes))
  
  if (length(risk_genes) < 10) {
    warning("Too few risk genes")
    return(NULL)
  }
  
  # Create GeneSet
  geneSets <- GeneSet(risk_genes, setName = "RiskGenes")
  
  # Extract expression matrix
  DefaultAssay(seurat_obj) <- "RNA"
  expr_matrix <- seurat_obj@assays$RNA@counts
  
  # Filter AD cells
  ad_cells <- rownames(seurat_obj@meta.data[seurat_obj@meta.data$orig.ident == 'LOAD', ])
  expr_matrix_ad <- expr_matrix[, ad_cells]
  metadata_ad <- seurat_obj@meta.data[ad_cells, ]
  
  clusters <- unique(metadata_ad$cell.type.number)
  vulnerability_results <- list()
  
  # Run AUCell for each cluster
  for (cluster in clusters) {
    message("  Processing: ", cluster)
    
    cluster_cells <- rownames(metadata_ad[metadata_ad$cell.type.number == cluster, ])
    cluster_matrix <- expr_matrix_ad[, cluster_cells]
    
    if (ncol(cluster_matrix) < 10) {
      warning("  Too few cells")
      next
    }
    
    tryCatch({
      # Build rankings
      cells_rankings <- AUCell_buildRankings(cluster_matrix, plotStats = FALSE, verbose = FALSE)
      
      # Calculate AUC
      cells_AUC <- AUCell_calcAUC(geneSets, cells_rankings, 
                                  aucMaxRank = nrow(cells_rankings) * 0.05)
      
      # Determine threshold
      set.seed(333)
      cells_assignment <- AUCell_exploreThresholds(cells_AUC, plotHist = FALSE, nCores = 1)
      
      threshold <- cells_assignment$RiskGenes$aucThr$selected
      if (is.null(threshold) || is.na(threshold)) {
        auc_values <- getAUC(cells_AUC)["RiskGenes", ]
        threshold <- median(auc_values) + 1.5 * mad(auc_values)
      }
      
      vulnerable_cells <- names(which(getAUC(cells_AUC)["RiskGenes", ] > threshold))
      
      vulnerability_results[[cluster]] <- list(
        cluster = cluster,
        total_cells = length(cluster_cells),
        vulnerable_cells = vulnerable_cells,
        n_vulnerable = length(vulnerable_cells),
        threshold = threshold,
        proportion = length(vulnerable_cells) / length(cluster_cells)
      )
      
      message("    Vulnerable: ", length(vulnerable_cells), "/", length(cluster_cells))
      
    }, error = function(e) {
      warning("  Failed: ", e$message)
    })
  }
  
  # Summarize
  if (length(vulnerability_results) > 0) {
    summary_df <- do.call(rbind, lapply(vulnerability_results, function(x) {
      data.frame(
        cluster = x$cluster,
        total_cells = x$total_cells,
        n_vulnerable = x$n_vulnerable,
        proportion = x$proportion,
        threshold = x$threshold
      )
    }))
    
    summary_df <- summary_df[order(-summary_df$proportion), ]
    
    dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
    write.csv(summary_df, file.path(output_dir, 'vulnerability_summary.csv'), row.names = FALSE)
    
    return(list(summary = summary_df, details = vulnerability_results))
  }
  
  return(NULL)
}

# Main
main <- function() {
  message("Step 10: Vulnerability Analysis")
  
  seurat_obj <- readRDS(file.path(PATHS$annotation_results,
                                  'AD.NORMAL.integrated_PCA_UMAP_annotated.rds'))
  
  gwas_ad <- read.csv(file.path(PATHS$gwas_data, 'ad.gwas.genes.csv'))$gene
  
  deg_files <- list.files(file.path(PATHS$deg_results, 'AD.NORMAL/NEBULA'),
                         pattern = '_sig_genes_NEBULA.csv$',
                         full.names = TRUE)
  
  all_degs <- unique(unlist(lapply(deg_files, function(f) read.csv(f)$gene)))
  
  output_dir <- file.path(PATHS$vulnerability_results, 'AD')
  
  results <- identify_vulnerable_cells(seurat_obj, gwas_ad, all_degs, output_dir)
  
  message("âœ“ Step 10 complete")
}

if (!interactive()) main()
